---
title: "Heatmaps"
author: "Liz Hughes"
date: "23/11/2021"
output:
  html_document:
    toc: yes
    toc_depth: 2
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document:
    toc: yes
    toc_depth: '2'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE , warning=FALSE, message=FALSE)
```

# Load packages used for analysis
```{r Load packages used for analysis, include=FALSE}

library(tidyr)
library(readr)
library(dplyr)
library(readxl)
library(stringr)
library(ggplot2)
library(cowplot)
library(biobroom)
library(DESeq2)
library(pheatmap)
library(RColorBrewer)
library(magrittr)
library(markdown)
library(forcats)


theme_set(
  theme_cowplot(font_size = 12) +
    theme(panel.grid.major = element_line(colour = "grey80", size = 0.5))
)

```


# Load count data and remove unwanted parts of column names

```{r Load count_data}

counts <- readr::read_tsv("~/GitHub/CryptoGat201RNASeq_draft_b/quantseqfwd_EH_050221/counts.txt",
                   comment = "#") %>% 
          dplyr::rename_with(str_remove_all, pattern = "_S[0-9]+_R1_001_aln.bam")

```


# Load sample sheet and format for DESeq2's requirements: readxl::read_excel

```{r Load sample_sheet}

samplesheet <- readxl::read_excel("~/GitHub/CryptoGat201RNASeq_draft_b/input_experiment/Gat201_samplesheet.xlsx") %>%
               magrittr::set_rownames(.$SampleID)%>%
               dplyr::mutate(GAT201 = forcats::fct_collapse(Strain, Yes = c("a","A"), No = c("B","M")))

```


# Select counts

```{r Select_counts_all}

counts_all <- dplyr::select(counts, samplesheet$SampleID) %>%
              magrittr::set_rownames(counts$Geneid)

```


# Construct the data object from the matrix of counts and the samplesheet information table

```{r dds_all_for_counts_all}

(dds_all <- DESeqDataSetFromMatrix(countData = counts_all,
                                  colData = samplesheet,
                                  design = ~ Condition + Strain + Time))

```


# rlog Transformation

```{r rlog_dds_all}

rld_all <- rlog(dds_all)
           head(assay(rld_all))
           
```


# Sample distances

```{r Sample_distances_rld_all}

sampleDists_all <- dist( t( assay(rld_all) ) )

```


# Heatmap

```{r Heatmap_rld_all}

sampleDistMatrix <- as.matrix(sampleDists_all)
                    rownames(sampleDistMatrix) <- paste( rld_all$Strain, rld_all$Condition, rld_all$Time, rld_all$GAT201, sep="-" )
                    colnames(sampleDistMatrix) <- NULL
                    
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists_all,
         clustering_distance_cols=sampleDists_all,
         col=colors, cex = 0.7,
         main = "Heatmap of SampleDists_all", )



```


## Prepare similar Heatmaps for each timepoint.

## Heatmap 0hrs

```{r heatmap_0hrs}
samplesheet_0h <-  dplyr::filter(samplesheet, Time == "0")
                  print(samplesheet_0h)

counts_0h <-  dplyr::select(counts_all, samplesheet_0h$SampleID) %>%
              magrittr::set_rownames(counts$Geneid)

(dds0h <- DESeqDataSetFromMatrix(countData = counts_0h,
                                 colData = samplesheet_0h,
                                 design = ~ Strain))

rld_0h <- rlog(dds0h)
          head(assay(rld_0h))

sampleDists_0h <- dist( t( assay(rld_0h) ) )
                  head(sampleDists_0h)

sampleDistMatrix_0h <- as.matrix( sampleDists_0h )
                       rownames(sampleDistMatrix_0h) <- paste( rld_0h$Strain, rld_0h$GAT201, sep="-" )
                       colnames(sampleDistMatrix_0h) <- NULL
                       
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pheatmap(sampleDistMatrix_0h,
         clustering_distance_rows=sampleDists_0h,
         clustering_distance_cols=sampleDists_0h,
         col=colors, cex = 1,
         main = "Heatmap of SampleDists_0h",)

```


## Heatmap 30min

```{r heatmap_30min}
samplesheet_30m <- dplyr::filter(samplesheet, Time == "30")
                   print(samplesheet_30m)

counts_30m <- dplyr::select(counts, samplesheet_30m$SampleID) %>%
              magrittr::set_rownames(counts$Geneid)

(dds30m <- DESeqDataSetFromMatrix(countData = counts_30m,
                                 colData = samplesheet_30m,
                                 design = ~ Condition + Strain))

rld_30m <- rlog(dds30m)
           head(assay(rld_30m))

sampleDists_30m <- dist( t( assay(rld_30m) ) )
           head(sampleDists_30m)

sampleDistMatrix_30m <- as.matrix( sampleDists_30m )
          rownames(sampleDistMatrix_30m) <- paste( rld_30m$Strain, rld_30m$Condition, sep="-" )
          colnames(sampleDistMatrix_30m) <- NULL
          
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pheatmap(sampleDistMatrix_30m,
         clustering_distance_rows=sampleDists_30m,
         clustering_distance_cols=sampleDists_30m,
         col=colors, cex = 1,
         main = "Heatmap of SampleDists_30m",)

```


## Heatmap 2hrs

```{r heatmap_2hrs}
samplesheet_2h <- dplyr::filter(samplesheet, Time == "120")
                  print(samplesheet_2h)

counts_2h <-   dplyr::select(counts, samplesheet_2h$SampleID) %>%
               magrittr::set_rownames(counts$Geneid)

(dds2h <- DESeqDataSetFromMatrix(countData = counts_2h,
                                 colData = samplesheet_2h,
                                 design = ~ Condition + Strain))

rld_2h <- rlog(dds2h)
          head(assay(rld_2h))

sampleDists_2h <- dist( t( assay(rld_2h) ) )
                  head(sampleDists_2h)

sampleDistMatrix_2h <- as.matrix( sampleDists_2h )
                      rownames(sampleDistMatrix_2h) <- paste( rld_2h$Strain, rld_2h$Condition, sep="-" )
                      colnames(sampleDistMatrix_2h) <- NULL
                      
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pheatmap(sampleDistMatrix_2h,
         clustering_distance_rows=sampleDists_2h,
         clustering_distance_cols=sampleDists_2h,
         col=colors, cex = 1,
         main = "Heatmap of SampleDists_2h",)

```


## Heatmap 4hrs

```{r heatmap_4hrs}
samplesheet_4h <- dplyr::filter(samplesheet, Time == "240")
                  print(samplesheet_4h)

counts_4h <-   dplyr::select(counts, samplesheet_4h$SampleID) %>%
               magrittr::set_rownames(counts$Geneid)

(dds4h <- DESeqDataSetFromMatrix(countData = counts_4h,
                                 colData = samplesheet_4h,
                                 design = ~ Condition + Strain))

rld_4h <- rlog(dds4h)
          head(assay(rld_4h))

sampleDists_4h <- dist( t( assay(rld_4h) ) )
                  head(sampleDists_4h)

sampleDistMatrix_4h <- as.matrix( sampleDists_4h )
                      rownames(sampleDistMatrix_4h) <- paste( rld_4h$Strain, rld_4h$Condition, sep="-" )
                      colnames(sampleDistMatrix_4h) <- NULL
                      
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pheatmap(sampleDistMatrix_4h,
         clustering_distance_rows=sampleDists_4h,
         clustering_distance_cols=sampleDists_4h,
         col=colors, cex = 1,
         main = "Heatmap of SampleDists_4h",)

```
