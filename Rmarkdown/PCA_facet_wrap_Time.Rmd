---
title: 'PCA analysis: facet_wrap'
author: "Liz Hughes"
date: "14/12/2021"
output:
  html_document:
    toc: yes
    toc_depth: 2
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document:
    toc: yes
    toc_depth: '2'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE , warning=FALSE, message=FALSE)
```

# Load packages used for analysis
```{r Load packages used for analysis, include=FALSE}

library(tidyr)
library(readr)
library(dplyr)
library(readxl)
library(stringr)
library(ggplot2)
library(cowplot)
library(biobroom)
library(DESeq2)
library(pheatmap)
library(RColorBrewer)
library(magrittr)
library(markdown)
library(forcats)
library(genefilter)
library(ggrepel)


theme_set(
  theme_cowplot(font_size = 12) +
    theme(panel.grid.major = element_line(colour = "grey80", size = 0.5))
)

```


# Load count data and remove unwanted parts of column names

```{r Load count data}

counts <- readr::read_tsv("~/GitHub/CryptoGat201RNASeq_draft_b/quantseqfwd_EH_050221/counts.txt",
                   comment = "#") %>% 
          dplyr::rename_with(str_remove_all, pattern = "_S[0-9]+_R1_001_aln.bam")

```


# Load sample sheet and format for DESeq2's requirements: readxl::read_excel

```{r Load sample sheet}

samplesheet <- readxl::read_excel("~/GitHub/CryptoGat201RNASeq_draft_b/input_experiment/Gat201_samplesheet.xlsx") %>%
    magrittr::set_rownames(.$SampleID)%>%
    dplyr::mutate(GAT201 = forcats::fct_collapse(Strain, WT = c("a","A"), Gat201 = c("B","M")))

```


# Change time in mins to time in hours

```{r Mutate time to hours}

 samplesheet <-mutate(samplesheet, Time = Time/60)
samplesheet


```

# Select counts

```{r Select_counts_all}

counts_all <-
      dplyr::select(counts, samplesheet$SampleID) %>%
      magrittr::set_rownames(counts$Geneid)

```



# Construct the data object from the matrix of counts and the samplesheet information table

```{r dds_counts_all}

(dds_all <- DESeqDataSetFromMatrix(countData = counts_all,
                                   colData = samplesheet,
                                   design = ~ Condition  + Time + GAT201))

```


# rlog transformation

```{r rlog_dds_all}

rld_all <- rlog(dds_all)
           head(assay(rld_all))
```


# PCA Plot function for PC1 and PC2

```{r function_12}

plotPCA <- function (object, intgroup = "condition", ntop = 500, returnData = FALSE) 
{
    rv <- rowVars(assay(object))
    select <- order(rv, decreasing = TRUE)[seq_len(min(ntop, 
        length(rv)))]
    pca <- prcomp(t(assay(object)[select, ]))
    percentVar <- pca$sdev^2/sum(pca$sdev^2)
    if (!all(intgroup %in% names(colData(object)))) {
        stop("the argument 'intgroup' should specify columns of colData(dds)")
    }
    intgroup.df <- as.data.frame(colData(object)[, intgroup, 
        drop = FALSE])
    group <- if (length(intgroup) > 1) {
        factor(apply(intgroup.df, 1, paste, collapse = " : "))
    }
    else {
        colData(object)[[intgroup]]
    }
    d <- data.frame(PC1 = pca$x[, 1], PC2 = pca$x[, 2], PC3 = pca$x[, 3], PC4 = pca$x[, 4], PC5 = pca$x[, 5], PC6 = pca$x[, 6],group = group, 
        intgroup.df, name = colnames(object))
    if (returnData) {
        attr(d, "percentVar") <- percentVar[1:2]
        return(d)
    }
    ggplot(data = d, aes_string(x = "PC1", y = "PC2", color = "group")) + 
        geom_point(size = 3) + xlab(paste0("PC1: ", round(percentVar[1] * 
        100), "% variance")) + ylab(paste0("PC2: ", round(percentVar[2] * 
        100), "% variance")) + coord_fixed()
    
  }

```

# as.factor Condition and Time

```{r as-factor}
dds_all$Condition <- as.factor(dds_all$Condition)

dds_all$Time <- as.factor(dds_all$Time)

colData(dds_all)
```

# PCA_1-2

```{r Plot_PC12}

plotPCA(rld_all, intgroup = c("GAT201", "Time", "Condition"))


```

# Plot PCA 1,2 Condition, Strain and Time

```{r PCA1,2_facetwrap_Time}

pcaData12 <- plotPCA(rld_all, intgroup=c("Condition", "GAT201", "Time"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData12, "percentVar"))
ggplot(pcaData12, aes(PC1, PC2, color=Condition, shape=GAT201)) +
  geom_point(size=3) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  coord_fixed() +
  theme_bw()+
  facet_wrap("Time")
```

# Plot PCA 2,3 Condition, Strain and Time

```{r PCA2,3_facetwrap_Time}

pcaData23 <- plotPCA(rld_all, intgroup=c("Condition", "GAT201", "Time"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData23, "percentVar"))
ggplot(pcaData23, aes(PC2, PC3, color=Condition, shape=GAT201)) +
  geom_point(size=3) +
  xlab(paste0("PC2: ",percentVar[2],"% variance")) +
  ylab(paste0("PC3: ",percentVar[3],"% variance")) + 
  coord_fixed() +
  theme_bw()+
  facet_wrap("Time")
```

# Plot PCA 3,4 Condition, Strain and Time

```{r PCA3,4_facetwrap_Time}

pcaData34 <- plotPCA(rld_all, intgroup=c("Condition", "GAT201", "Time"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData34, "percentVar"))
ggplot(pcaData34, aes(PC3, PC4, color=Condition, shape=GAT201)) +
  geom_point(size=3) +
  xlab(paste0("PC3: ",percentVar[3],"% variance")) +
  ylab(paste0("PC4: ",percentVar[4],"% variance")) + 
  coord_fixed() +
  theme_bw()+
  facet_wrap("Time")
```

# Plot PCA 4,5 Condition, Strain and Time

```{r PCA4,5_facetwrap_Time}

pcaData45 <- plotPCA(rld_all, intgroup=c("Condition", "GAT201", "Time"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData45, "percentVar"))
ggplot(pcaData45, aes(PC4, PC5, color=Condition, shape=GAT201)) +
  geom_point(size=3) +
  xlab(paste0("PC4: ",percentVar[4],"% variance")) +
  ylab(paste0("PC5: ",percentVar[5],"% variance")) + 
  coord_fixed() +
  theme_bw()+
  facet_wrap("Time")
```

# Plot PCA 5,6 Condition, Strain and Time
```{r PCA5,6_facetwrap_Time}
pcaData56 <- plotPCA(rld_all, intgroup=c("Condition", "GAT201", "Time"), returnData=TRUE)
percentVar <- round(100 * attr(pcaData56, "percentVar"))
ggplot(pcaData56, aes(PC5, PC6, color=Condition, shape=GAT201)) +
  geom_point(size=3) +
  xlab(paste0("PC5: ",percentVar[5],"% variance")) +
  ylab(paste0("PC6: ",percentVar[6],"% variance")) + 
  coord_fixed() +
  theme_bw()+
  facet_wrap("Time")
```



